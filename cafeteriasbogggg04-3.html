<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- Meta tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cafeterías Bogotá">
    
    <!-- Meta tags para Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>Cafeterías de Bogotá - Jenn & Vale</title>
    
    <!-- Leaflet CSS para el mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome para iconos y estrellas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Touch icon para iOS -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/000000/coffee-to-go.png">
    
    <style>
        /* Prevenir selección de texto en iOS */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        /* Permitir selección en campos de entrada */
        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            background-color: #f0f7ff;
            color: #2c3e50;
            overflow-x: hidden;
            /* Prevenir zoom en iOS */
            touch-action: pan-x pan-y;
        }

        /* Mejorar toques en móviles */
        button, .cafe-item, .star {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        /* Ajustar tamaño mínimo de toque */
        button, .cafe-item {
            min-height: 44px;
        }

        header {
            background: linear-gradient(to right, #1e3a8a, #dc2626);
            color: #fff;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .reviewers {
            display: inline-flex;
            gap: 15px;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            border-radius: 50px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .reviewer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .reviewer-icon {
            background-color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .reviewer-jenn .reviewer-icon {
            background-color: #1e3a8a;
            color: white;
        }

        .reviewer-vale .reviewer-icon {
            background-color: #dc2626;
            color: white;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            gap: 15px;
            min-height: calc(100vh - 200px);
        }

        .map-container {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            background-color: white;
            height: 50vh;
            min-height: 400px;
            order: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 100%;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            overflow-y: auto;
            max-height: none;
            order: 2;
        }

        /* Ocultar scrollbar pero mantener funcionalidad */
        .sidebar::-webkit-scrollbar {
            width: 5px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .section-title {
            color: #1e3a8a;
            border-bottom: 2px solid #bfdbfe;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cafe-list {
            margin-bottom: 25px;
        }

        .cafe-item {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 5px solid #1e3a8a;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .cafe-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .cafe-item.selected {
            border-left: 5px solid #dc2626;
            background-color: #fff1f1;
        }

        .cafe-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #1e3a8a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cafe-rating-overall {
            background: linear-gradient(to right, #1e3a8a, #dc2626);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .cafe-location {
            font-size: 0.9rem;
            color: #475569;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ratings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .rating-section {
            flex: 1;
        }

        .rating-title {
            font-size: 0.9rem;
            color: #475569;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stars {
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .average-rating {
            font-size: 0.9rem;
            color: #64748b;
            margin-left: 8px;
        }

        .comments-section {
            background-color: #f1f5f9;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .comment {
            padding: 8px 0;
            border-bottom: 1px solid #cbd5e1;
            font-size: 0.9rem;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment-author {
            font-weight: bold;
        }

        .comment-author.jenn {
            color: #1e3a8a;
        }

        .comment-author.vale {
            color: #dc2626;
        }

        .comment-date {
            font-size: 0.8rem;
            color: #64748b;
            margin-left: 8px;
        }

        .comment-text {
            margin-top: 4px;
        }

        .add-form {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed #bfdbfe;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3a8a;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Mejorar inputs en iOS */
        input[type="text"],
        input[type="number"],
        textarea {
            font-size: 16px; /* Evita zoom automático en iOS */
        }

        input:focus, select:focus, textarea:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-ratings {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 15px 0;
        }

        .form-rating {
            flex: 1;
        }

        .form-rating .stars {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .form-rating .star {
            font-size: 1.8rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            padding: 5px;
        }

        .form-rating .star:hover {
            transform: scale(1.1);
        }

        .form-rating .star.selected {
            color: #fbbf24;
        }

        .rating-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rating-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .rating-icon.jenn {
            background-color: #1e3a8a;
        }

        .rating-icon.vale {
            background-color: #dc2626;
        }

        button {
            background: linear-gradient(to right, #1e3a8a, #832828);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s, transform 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-jenn {
            background: #1e3a8a;
        }

        .btn-vale {
            background: #7a1313;
        }

        .btn-add-comment {
            background: #059669;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            margin-top: 0;
            padding: 12px;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #475569;
            border-top: 1px solid #cbd5e1;
            background-color: #f8fafc;
            font-size: 0.9rem;
        }

        .instructions {
            background: linear-gradient(135deg, #dbeafe, #fee2e2);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
            border-left: 4px solid #1e3a8a;
            border-right: 4px solid #dc2626;
        }

        .instructions strong {
            color: #1e3a8a;
        }

        .instructions .highlight {
            color: #dc2626;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #1e3a8a, #dc2626);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Ajustes para tablets */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                padding: 20px;
            }
            
            .map-container {
                flex: 1;
                height: calc(100vh - 200px);
                min-height: 600px;
                order: 1;
            }
            
            .sidebar {
                flex: 0 0 400px;
                max-height: calc(100vh - 200px);
                order: 2;
            }
            
            .ratings-container, .form-ratings {
                flex-direction: row;
            }
            
            .reviewers {
                flex-direction: row;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }

        /* Ajustes para desktop */
        @media (min-width: 1024px) {
            .container {
                max-width: 1600px;
            }
            
            .sidebar {
                flex: 0 0 450px;
            }
        }

        /* Prevenir zoom en inputs en iOS */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            select:focus,
            textarea:focus,
            input:focus {
                font-size: 16px;
            }
        }

        /* Estilos para el popup del mapa */
        .leaflet-popup-content {
            min-width: 250px;
            max-width: 300px;
        }

        .popup-cafe-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 8px;
        }

        .popup-rating {
            margin: 10px 0;
        }

        .popup-comment {
            background-color: #f1f5f9;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Mejorar interacción táctil en el mapa */
        .leaflet-container {
            font: 12px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-mug-hot"></i> memorias y abrazos en tazas de café</h1>
        <p class="subtitle">Sistema de recorrido de Jenn y Valerita</p>
        <div class="reviewers">
            <div class="reviewer reviewer-jenn">
                <div class="reviewer-icon">J</div>
                <span>Jenn</span>
            </div>
            <div class="reviewer reviewer-vale">
                <div class="reviewer-icon">V</div>
                <span>Valerita</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="instructions">
                <p><strong>¡Buen día, cielo!</strong> Calificaremos cafeterías (1-5 estrellas) y podemos añadir comentarios. Que lindo poder compartir esto contigo. Ojalà toda una vida <span class="highlight">¡será super divertido!</span></p>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-cafes">14</div>
                    <div class="stat-label">Cafeterías</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-rating">0.0</div>
                    <div class="stat-label">Puntuación</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-reviews">0</div>
                    <div class="stat-label">Calificaciones</div>
                </div>
            </div>
            
            <div class="cafe-list">
                <h2 class="section-title"><i class="fas fa-list"></i> Cafeterías por Calificar</h2>
                <div id="cafe-list-container">
                    <!-- Las cafeterías se cargarán aquí dinámicamente -->
                </div>
            </div>
            
            <div class="add-form">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Añadir Nueva Cafetería</h2>
                <form id="add-cafe-form">
                    <div class="form-group">
                        <label for="cafe-name">Nombre</label>
                        <input type="text" id="cafe-name" placeholder="Ej: Café de la Montaña" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cafe-address">Dirección</label>
                        <input type="text" id="cafe-address" placeholder="Ej: Chapinero, Calle 70 #7-20" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Ubicación en el mapa</label>
                        <p style="font-size: 0.9rem; color: #475569; margin-top: 5px;">Toca el mapa para seleccionar ubicación</p>
                        <input type="text" id="cafe-coords" placeholder="Coordenadas: Lat, Lng" readonly required>
                    </div>
                    
                    <div class="form-ratings">
                        <div class="form-rating">
                            <div class="rating-label">
                                <div class="rating-icon jenn">J</div>
                                <span>Jenn</span>
                            </div>
                            <div class="stars" id="form-rating-jenn">
                                <i class="fas fa-star star" data-value="1"></i>
                                <i class="fas fa-star star" data-value="2"></i>
                                <i class="fas fa-star star" data-value="3"></i>
                                <i class="fas fa-star star" data-value="4"></i>
                                <i class="fas fa-star star" data-value="5"></i>
                            </div>
                            <input type="hidden" id="cafe-rating-jenn" value="0" required>
                        </div>
                        
                        <div class="form-rating">
                            <div class="rating-label">
                                <div class="rating-icon vale">V</div>
                                <span>Vale</span>
                            </div>
                            <div class="stars" id="form-rating-vale">
                                <i class="fas fa-star star" data-value="1"></i>
                                <i class="fas fa-star star" data-value="2"></i>
                                <i class="fas fa-star star" data-value="3"></i>
                                <i class="fas fa-star star" data-value="4"></i>
                                <i class="fas fa-star star" data-value="5"></i>
                            </div>
                            <input type="hidden" id="cafe-rating-vale" value="0" required>
                        </div>
                    </div>
                    
                    <button type="submit"><i class="fas fa-plus"></i> Añadir Cafetería</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>memorias y abrazos en tazas de café &copy; 2026 | Jenn & Vale</p>
        <p style="margin-top: 10px; font-size: 0.9rem;">Datos guardados automáticamente | Actualizado: <span id="last-update"></span></p>
    </footer>

    <!-- Leaflet JS para el mapa -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Datos iniciales de cafeterías en Bogotá - 14 cafeterías sin calificaciones
        let cafes = [
            {
                id: 1,
                name: "Café Cultor",
                address: "Chapinero, Calle 70 #7-20",
                description: "Café de especialidad con tostión propia y métodos de preparación artesanales.",
                lat: 4.6561,
                lng: -74.0596,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2026-09-15"
            },
            {
                id: 2,
                name: "Varietale",
                address: "Usaquén, Carrera 6 #119-14",
                description: "Cadena colombiana de café de especialidad con múltiples sedes en Bogotá.",
                lat: 4.6937,
                lng: -74.0331,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2026-09-10"
            },
            {
                id: 3,
                name: "Bourbon Coffee Roasters",
                address: "Zona G, Calle 70 #4-78",
                description: "Tostaduría de café con granos de alta calidad y ambiente moderno.",
                lat: 4.6589,
                lng: -74.0602,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-08-20"
            },
            {
                id: 4,
                name: "Café Devoción",
                address: "Chapinero, Carrera 7 #67-39",
                description: "Café fresco tostado en Brooklyn y enviado directamente a Bogotá.",
                lat: 4.6532,
                lng: -74.0589,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-08-25"
            },
            {
                id: 5,
                name: "Café San Alberto",
                address: "Zona T, Calle 82 #12-15",
                description: "Café de origen único del Quindío, preparado con técnicas profesionales.",
                lat: 4.6672,
                lng: -74.0554,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-05"
            },
            {
                id: 6,
                name: "Azahar Café",
                address: "La Candelaria, Calle 10 #2-13",
                description: "Cadena de café colombiano enfocada en la trazabilidad del grano.",
                lat: 4.5981,
                lng: -74.0760,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-08-30"
            },
            {
                id: 7,
                name: "LIBRERÍA Café & Libros",
                address: "Chapinero, Calle 70A #7-76",
                description: "Cafetería y librería combinadas en un espacio cultural único.",
                lat: 4.6575,
                lng: -74.0582,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-12"
            },
            {
                id: 8,
                name: "Colo Coffee",
                address: "Quinta Camacho, Calle 70 #7-44",
                description: "Minicadena de café de especialidad con enfoque en métodos alternativos.",
                lat: 4.6565,
                lng: -74.0598,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-08"
            },
            {
                id: 9,
                name: "Café del Fondo",
                address: "Usaquén, Carrera 5 #119-30",
                description: "Cafetería de especialidad con ambiente rústico y acogedor.",
                lat: 4.6921,
                lng: -74.0325,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-18"
            },
            {
                id: 10,
                name: "Orígenes Café de Colombia",
                address: "Chapinero Alto, Calle 65 #4-76",
                description: "Cafetería que ofrece granos de diferentes regiones del país.",
                lat: 4.6523,
                lng: -74.0615,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-25"
            },
            {
                id: 11,
                name: "Café Quindío",
                address: "La Macarena, Carrera 4 #26-04",
                description: "Cafetería tradicional colombiana con el mejor café del Quindío.",
                lat: 4.6078,
                lng: -74.0701,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-14"
            },
            {
                id: 12,
                name: "Juan Valdez Café (Flagship)",
                address: "Parque 93, Calle 93A #13-20",
                description: "La tienda insignia de la cadena de café colombiana más reconocida mundialmente.",
                lat: 4.6779,
                lng: -74.0483,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-08-22"
            },
            {
                id: 13,
                name: "The Coffee Box",
                address: "Rosales, Calle 79 #11-43",
                description: "Cafetería minimalista con enfoque en la calidad del grano y preparación precisa.",
                lat: 4.6627,
                lng: -74.0563,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-20"
            },
            {
                id: 14,
                name: "Café del Museo",
                address: "Museo Nacional, Carrera 7 #28-66",
                description: "Cafetería dentro del Museo Nacional con ambiente cultural y café de calidad.",
                lat: 4.6162,
                lng: -74.0681,
                ratingJenn: 0,
                ratingVale: 0,
                ratingsJenn: [],
                ratingsVale: [],
                comments: [],
                addedDate: "2023-09-10"
            }
        ];

        // Variable para almacenar el mapa y marcadores
        let map;
        let markers = [];
        let selectedLocationMarker = null;
        let selectedCoords = null;
        let selectedCafeId = null;

        // Inicializar el mapa cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            renderCafeList();
            updateStats();
            setupEventListeners();
            updateLastUpdateTime();
            
            // Intentar cargar datos del localStorage
            loadFromLocalStorage();
            
            // Registrar Service Worker para PWA
            registerServiceWorker();
        });

        // Función para inicializar el mapa
        function initMap() {
            // Coordenadas del centro de Bogotá
            const bogotaCenter = [4.6097, -74.0817];
            
            // Crear el mapa con ajustes para móviles
            map = L.map('map', {
                tap: true, // Habilitar toques en móviles
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                keyboard: true
            }).setView(bogotaCenter, 12);
            
            // Añadir capa de mapa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Añadir marcadores para cada cafetería
            cafes.forEach(cafe => {
                addMarkerToMap(cafe);
            });
            
            // Escuchar clics/touch en el mapa para añadir nuevas ubicaciones
            map.on('click', function(e) {
                selectedCoords = [e.latlng.lat, e.latlng.lng];
                
                // Actualizar el campo de coordenadas
                document.getElementById('cafe-coords').value = `${selectedCoords[0].toFixed(4)}, ${selectedCoords[1].toFixed(4)}`;
                
                // Limpiar marcador anterior si existe
                if (selectedLocationMarker) {
                    map.removeLayer(selectedLocationMarker);
                }
                
                // Añadir nuevo marcador
                selectedLocationMarker = L.marker(selectedCoords, {
                    icon: L.divIcon({
                        className: 'selected-location-marker',
                        html: '<i class="fas fa-map-pin" style="color: #dc2626; font-size: 30px;"></i>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    })
                }).addTo(map);
            });
            
            // Ajustar mapa cuando se redimensione la ventana
            window.addEventListener('resize', function() {
                map.invalidateSize();
            });
        }

        // Función para añadir un marcador al mapa
        function addMarkerToMap(cafe) {
            // Calcular el rating general promedio
            const overallRating = cafe.ratingJenn > 0 || cafe.ratingVale > 0 
                ? ((cafe.ratingJenn + cafe.ratingVale) / 2).toFixed(1) 
                : "?";
            
            // Determinar color según rating
            let iconColor = '#1e3a8a'; // azul por defecto
            let iconText = overallRating;
            
            if (overallRating !== "?") {
                const ratingNum = parseFloat(overallRating);
                
                if (ratingNum >= 4.0) iconColor = '#059669'; // verde para alta puntuación
                else if (ratingNum >= 3.0) iconColor = '#d97706'; // naranja para puntuación media
                else if (ratingNum > 0) iconColor = '#dc2626'; // rojo para baja puntuación
            }
            
            // Crear ícono personalizado
            const cafeIcon = L.divIcon({
                className: 'cafe-marker',
                html: `<div style="background-color: ${iconColor}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${iconText}</div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            // Crear marcador
            const marker = L.marker([cafe.lat, cafe.lng], { 
                icon: cafeIcon,
                title: cafe.name
            })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 250px;">
                        <div class="popup-cafe-name">${cafe.name}</div>
                        <div style="margin-bottom: 5px;">${cafe.address}</div>
                        
                        <div style="margin-bottom: 10px;">
                            <div><strong>Jenn:</strong> ${cafe.ratingJenn > 0 ? generateStarRating(cafe.ratingJenn) + ` (${cafe.ratingJenn.toFixed(1)})` : 'Sin calificar'}</div>
                            <div><strong>Vale:</strong> ${cafe.ratingVale > 0 ? generateStarRating(cafe.ratingVale) + ` (${cafe.ratingVale.toFixed(1)})` : 'Sin calificar'}</div>
                        </div>
                        
                        ${cafe.comments.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <strong>Último comentario:</strong>
                            <div class="popup-comment">
                                <div><strong>${cafe.comments[cafe.comments.length-1].author}:</strong> ${cafe.comments[cafe.comments.length-1].text}</div>
                                <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${cafe.comments[cafe.comments.length-1].date} ${cafe.comments[cafe.comments.length-1].time}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="selectCafe(${cafe.id})" style="background: linear-gradient(to right, #1e3a8a, #dc2626); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%;">Calificar esta cafetería</button>
                        </div>
                    </div>
                `);
            
            // Almacenar referencia al marcador
            markers.push({ cafeId: cafe.id, marker: marker });
            
            // Configurar evento para seleccionar cafetería al hacer clic en el marcador
            marker.on('click', function() {
                selectCafe(cafe.id);
            });
        }

        // Función para seleccionar una cafetería
        function selectCafe(cafeId) {
            selectedCafeId = cafeId;
            
            // Actualizar la lista para resaltar la cafetería seleccionada
            renderCafeList();
            
            // Desplazarse a la cafetería en la lista
            const cafeElement = document.querySelector(`.cafe-item[data-cafe-id="${cafeId}"]`);
            if (cafeElement) {
                cafeElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Centrar el mapa en la cafetería seleccionada
            const cafe = cafes.find(c => c.id === cafeId);
            if (cafe) {
                map.setView([cafe.lat, cafe.lng], 15);
            }
        }

        // Función para generar estrellas para mostrar la calificación
        function generateStarRating(rating) {
            if (rating === 0) return 'Sin calificar';
            
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            
            return `<span class="stars">${stars}</span>`;
        }

        // Función para renderizar la lista de cafeterías
        function renderCafeList() {
            const container = document.getElementById('cafe-list-container');
            container.innerHTML = '';
            
            // Ordenar cafeterías por rating general (promedio de Jenn y Vale)
            const sortedCafes = [...cafes].sort((a, b) => {
                const ratingA = (a.ratingJenn + a.ratingVale) / 2;
                const ratingB = (b.ratingJenn + b.ratingVale) / 2;
                
                // Si ambas no tienen calificaciones, mantener orden original
                if (ratingA === 0 && ratingB === 0) return a.id - b.id;
                // Si A no tiene calificación, ponerla después
                if (ratingA === 0) return 1;
                // Si B no tiene calificación, ponerla después
                if (ratingB === 0) return -1;
                // Orden descendente por rating
                return ratingB - ratingA;
            });
            
            sortedCafes.forEach(cafe => {
                const overallRating = cafe.ratingJenn > 0 || cafe.ratingVale > 0 
                    ? ((cafe.ratingJenn + cafe.ratingVale) / 2).toFixed(1) 
                    : "0.0";
                
                const isSelected = cafe.id === selectedCafeId;
                
                const cafeElement = document.createElement('div');
                cafeElement.className = `cafe-item ${isSelected ? 'selected' : ''}`;
                cafeElement.setAttribute('data-cafe-id', cafe.id);
                cafeElement.innerHTML = `
                    <div class="cafe-name">
                        <span>${cafe.name}</span>
                        <span class="cafe-rating-overall">${overallRating}</span>
                    </div>
                    <div class="cafe-location">
                        <i class="fas fa-map-marker-alt"></i> ${cafe.address}
                    </div>
                    <div class="ratings-container">
                        <div class="rating-section">
                            <div class="rating-title">
                                <div class="rating-icon jenn">J</div>
                                <span>Jenn</span>
                            </div>
                            <div class="stars">${generateStarRating(cafe.ratingJenn)}</div>
                            <div class="average-rating">${cafe.ratingJenn > 0 ? cafe.ratingJenn.toFixed(1) : '0.0'} (${cafe.ratingsJenn.length})</div>
                        </div>
                        <div class="rating-section">
                            <div class="rating-title">
                                <div class="rating-icon vale">V</div>
                                <span>Vale</span>
                            </div>
                            <div class="stars">${generateStarRating(cafe.ratingVale)}</div>
                            <div class="average-rating">${cafe.ratingVale > 0 ? cafe.ratingVale.toFixed(1) : '0.0'} (${cafe.ratingsVale.length})</div>
                        </div>
                    </div>
                    ${cafe.comments.length > 0 ? `
                    <div class="comments-section">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Últimos comentarios:</div>
                        ${cafe.comments.slice(-2).map(comment => `
                            <div class="comment">
                                <div>
                                    <span class="comment-author ${comment.author === 'Jenn' ? 'jenn' : 'vale'}">${comment.author}</span>
                                    <span class="comment-date">${comment.date} ${comment.time}</span>
                                </div>
                                <div class="comment-text">${comment.text}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    <div class="action-buttons">
                        <button onclick="rateCafe(${cafe.id}, 'Jenn')" class="btn-jenn">Calificar Jenn</button>
                        <button onclick="rateCafe(${cafe.id}, 'Vale')" class="btn-vale">Calificar Vale</button>
                    </div>
                    <div>
                        <button onclick="addCommentToCafe(${cafe.id})" class="btn-add-comment">Añadir comentario</button>
                    </div>
                `;
                
                // Añadir evento de clic/touch a toda la tarjeta
                cafeElement.addEventListener('click', function(e) {
                    // Solo si no se hizo clic en un botón
                    if (!e.target.closest('button')) {
                        selectCafe(cafe.id);
                    }
                });
                
                container.appendChild(cafeElement);
            });
        }

        // Función para calificar una cafetería
        function rateCafe(cafeId, rater) {
            const newRating = prompt(`${rater}: Ingresa una calificación de 1 a 5 estrellas:`);
            if (newRating === null) return; // Usuario canceló
            
            const rating = parseFloat(newRating);
            if (isNaN(rating) || rating < 1 || rating > 5) {
                alert('Por favor, ingresa un número válido entre 1 y 5.');
                return;
            }
            
            // Buscar la cafetería
            const cafeIndex = cafes.findIndex(c => c.id === cafeId);
            if (cafeIndex === -1) return;
            
            // Añadir la nueva calificación
            if (rater === 'Jenn') {
                cafes[cafeIndex].ratingsJenn.push(rating);
                // Recalcular el promedio
                const sum = cafes[cafeIndex].ratingsJenn.reduce((a, b) => a + b, 0);
                cafes[cafeIndex].ratingJenn = sum / cafes[cafeIndex].ratingsJenn.length;
            } else if (rater === 'Vale') {
                cafes[cafeIndex].ratingsVale.push(rating);
                // Recalcular el promedio
                const sum = cafes[cafeIndex].ratingsVale.reduce((a, b) => a + b, 0);
                cafes[cafeIndex].ratingVale = sum / cafes[cafeIndex].ratingsVale.length;
            }
            
            // Actualizar la lista, estadísticas y guardar en localStorage
            renderCafeList();
            updateStats();
            saveToLocalStorage();
            updateLastUpdateTime();
            
            // Actualizar marcador en el mapa
            updateMapMarker(cafeId);
            
            // Mostrar confirmación
            alert(`¡${rater} ha calificado "${cafes[cafeIndex].name}" con ${rating} estrellas!`);
        }

        // Función para actualizar el marcador en el mapa
        function updateMapMarker(cafeId) {
            // Encontrar el marcador existente
            const markerIndex = markers.findIndex(m => m.cafeId === cafeId);
            if (markerIndex === -1) return;
            
            // Eliminar el marcador antiguo
            map.removeLayer(markers[markerIndex].marker);
            
            // Encontrar la cafetería
            const cafe = cafes.find(c => c.id === cafeId);
            if (!cafe) return;
            
            // Añadir nuevo marcador
            addMarkerToMap(cafe);
            
            // Reemplazar en el array
            markers.splice(markerIndex, 1);
        }

        // Función para añadir un comentario a una cafetería
        function addCommentToCafe(cafeId) {
            const cafeIndex = cafes.findIndex(c => c.id === cafeId);
            if (cafeIndex === -1) return;
            
            const commentText = prompt(`Ingresa tu comentario para ${cafes[cafeIndex].name}:`);
            if (!commentText || commentText.trim() === '') return;
            
            const author = prompt("¿Quién escribe el comentario? (Jenn o Vale):");
            if (!author || (author !== 'Jenn' && author !== 'Vale')) {
                alert('Por favor, ingresa "Jenn" o "Vale" como autor.');
                return;
            }
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            
            cafes[cafeIndex].comments.push({
                author: author,
                text: commentText,
                date: date,
                time: time
            });
            
            // Actualizar y guardar
            renderCafeList();
            saveToLocalStorage();
            updateLastUpdateTime();
            
            alert(`Comentario de ${author} añadido exitosamente.`);
        }

        // Función para configurar los event listeners
        function setupEventListeners() {
            // Estrellas del formulario para Jenn
            const formStarsJenn = document.querySelectorAll('#form-rating-jenn .star');
            formStarsJenn.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-value'));
                    setFormRating('jenn', rating);
                });
                
                // Añadir evento táctil para móviles
                star.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const rating = parseInt(this.getAttribute('data-value'));
                    setFormRating('jenn', rating);
                });
            });
            
            // Estrellas del formulario para Vale
            const formStarsVale = document.querySelectorAll('#form-rating-vale .star');
            formStarsVale.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-value'));
                    setFormRating('vale', rating);
                });
                
                // Añadir evento táctil para móviles
                star.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const rating = parseInt(this.getAttribute('data-value'));
                    setFormRating('vale', rating);
                });
            });
            
            // Formulario para añadir nueva cafetería
            document.getElementById('add-cafe-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewCafe();
            });
            
            // Prevenir zoom con doble toque en el mapa en móviles
            document.getElementById('map').addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Función para establecer la calificación en el formulario
        function setFormRating(rater, rating) {
            const stars = document.querySelectorAll(`#form-rating-${rater} .star`);
            const ratingInput = document.getElementById(`cafe-rating-${rater}`);
            
            // Actualizar visualmente las estrellas
            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                if (starValue <= rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
            
            // Actualizar el valor oculto
            ratingInput.value = rating;
        }

        // Función para añadir una nueva cafetería
        function addNewCafe() {
            const name = document.getElementById('cafe-name').value;
            const address = document.getElementById('cafe-address').value;
            const ratingJenn = parseInt(document.getElementById('cafe-rating-jenn').value);
            const ratingVale = parseInt(document.getElementById('cafe-rating-vale').value);
            
            // Validar que se haya seleccionado una ubicación
            if (!selectedCoords) {
                alert('Por favor, selecciona una ubicación en el mapa tocando en él.');
                return;
            }
            
            // Validar las calificaciones
            if (ratingJenn < 1 || ratingJenn > 5 || ratingVale < 1 || ratingVale > 5) {
                alert('Por favor, selecciona una calificación de 1 a 5 estrellas para Jenn y Vale.');
                return;
            }
            
            // Obtener fecha y hora actual
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            
            // Crear nueva cafetería
            const newCafe = {
                id: cafes.length > 0 ? Math.max(...cafes.map(c => c.id)) + 1 : 1,
                name: name,
                address: address,
                description: "",
                lat: selectedCoords[0],
                lng: selectedCoords[1],
                ratingJenn: ratingJenn,
                ratingVale: ratingVale,
                ratingsJenn: [ratingJenn],
                ratingsVale: [ratingVale],
                comments: [],
                addedDate: date
            };
            
            // Añadir a la lista
            cafes.push(newCafe);
            
            // Añadir marcador al mapa
            addMarkerToMap(newCafe);
            
            // Actualizar la lista y estadísticas
            renderCafeList();
            updateStats();
            
            // Guardar en localStorage
            saveToLocalStorage();
            updateLastUpdateTime();
            
            // Restablecer el formulario
            document.getElementById('add-cafe-form').reset();
            setFormRating('jenn', 0);
            setFormRating('vale', 0);
            document.getElementById('cafe-coords').value = '';
            
            // Eliminar el marcador de ubicación seleccionada
            if (selectedLocationMarker) {
                map.removeLayer(selectedLocationMarker);
                selectedLocationMarker = null;
            }
            
            selectedCoords = null;
            
            // Mostrar mensaje de confirmación
            alert(`¡Cafetería "${name}" añadida exitosamente!`);
        }

        // Función para actualizar las estadísticas
        function updateStats() {
            // Total cafeterías
            document.getElementById('total-cafes').textContent = cafes.length;
            
            // Puntuación media (promedio de todos los ratings)
            let totalRatings = 0;
            let count = 0;
            
            cafes.forEach(cafe => {
                if (cafe.ratingJenn > 0) {
                    totalRatings += cafe.ratingJenn;
                    count++;
                }
                if (cafe.ratingVale > 0) {
                    totalRatings += cafe.ratingVale;
                    count++;
                }
            });
            
            const avgRating = count > 0 ? (totalRatings / count).toFixed(1) : "0.0";
            document.getElementById('avg-rating').textContent = avgRating;
            
            // Total de calificaciones
            let totalReviews = 0;
            cafes.forEach(cafe => {
                totalReviews += cafe.ratingsJenn.length + cafe.ratingsVale.length;
            });
            
            document.getElementById('total-reviews').textContent = totalReviews;
        }

        // Función para actualizar la última hora de actualización
        function updateLastUpdateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            document.getElementById('last-update').textContent = `${dateStr} a las ${timeStr}`;
        }

        // Función para guardar datos en localStorage
        function saveToLocalStorage() {
            localStorage.setItem('bogota-cafes-jenn-vale', JSON.stringify(cafes));
            localStorage.setItem('bogota-cafes-last-update', new Date().toISOString());
        }

        // Función para cargar datos desde localStorage
        function loadFromLocalStorage() {
            const savedCafes = localStorage.getItem('bogota-cafes-jenn-vale');
            if (savedCafes) {
                cafes = JSON.parse(savedCafes);
                
                // Limpiar marcadores existentes
                markers.forEach(markerObj => {
                    map.removeLayer(markerObj.marker);
                });
                markers = [];
                
                // Añadir marcadores desde los datos cargados
                cafes.forEach(cafe => {
                    addMarkerToMap(cafe);
                });
                
                // Actualizar la lista y estadísticas
                renderCafeList();
                updateStats();
            }
        }

        // Función para registrar Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(function(registration) {
                            console.log('ServiceWorker registrado con éxito: ', registration.scope);
                        })
                        .catch(function(err) {
                            console.log('Error al registrar ServiceWorker: ', err);
                        });
                });
            }
        }
    </script>
</body>
</html>